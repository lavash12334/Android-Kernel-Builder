name: "üöÄ Build & Package Kernel (Auto-Zip)"

env:
  CONFIGURATION: "repos.json"
  OUT_DIR: "out"

on:
  workflow_dispatch:

jobs:
  Set-repos:
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.generate-matrix.outputs.repos }}
    steps:
      - uses: actions/checkout@v4
      - id: generate-matrix
        run: echo "repos=$(cat ${{ env.CONFIGURATION }} | tr -d '\n')" >> $GITHUB_OUTPUT

  Build-Kernel:
    needs: Set-repos
    runs-on: ubuntu-latest
    container:
      image: ubuntu:20.04

    strategy:
      fail-fast: false
      matrix:
        repos: ${{ fromJSON(needs.Set-repos.outputs.repos) }}

    env:
      kernelDir: ${{ matrix.repos.kernelSource.name }}_${{ matrix.repos.kernelSource.device }}
      kernelName: ${{ matrix.repos.kernelSource.name }}
      DEFCONFIG_NAME: ${{ matrix.repos.params.DEFCONFIG }}

    steps:
      - name: "üì¶ Install dependencies"
        run: |
          apt-get update && apt-get install -y software-properties-common
          add-apt-repository universe
          apt-get update
          apt-get install -y build-essential bc curl git zip gcc-aarch64-linux-gnu \
          gcc-arm-linux-gnueabi libssl-dev lftp zstd wget libfl-dev python2 \
          libarchive-tools jq cpio
          ln -sf /usr/bin/python2 /usr/bin/python

      - name: "üåü Clone Source"
        run: |
          mkdir -p $kernelDir
          git clone --depth=1 --branch ${{ matrix.repos.kernelSource.branch }} ${{ matrix.repos.kernelSource.repo }} $kernelDir/$kernelName

      - name: "üí´ Clone Toolchains"
        working-directory: ${{ env.kernelDir }}
        run: |
          echo '${{ toJSON(matrix.repos.toolchains) }}' | jq -c '.[]' | while read i; do
            name=$(echo $i | jq -r '.name')
            repo=$(echo $i | jq -r '.repo')
            branch=$(echo $i | jq -r '.branch')
            git clone --depth=1 --branch $branch $repo $name
          done

      - name: "üé∂ Build Kernel"
        working-directory: ${{ env.kernelDir }}/${{ env.kernelName }}
        run: |
          GCC64="$(pwd)/../gcc64/bin/${{ matrix.repos.params.CROSS_COMPILE }}"
          GCC32="$(pwd)/../gcc32/bin/${{ matrix.repos.params.CROSS_COMPILE_ARM32 }}"
          mkdir -p ${{ env.OUT_DIR }}
          
          # –ö–æ–Ω—Ñ–∏–≥
          make O=${{ env.OUT_DIR }} ARCH=arm64 CROSS_COMPILE="$GCC64" ${{ env.DEFCONFIG_NAME }}
          
          # –°–±–æ—Ä–∫–∞
          make O=${{ env.OUT_DIR }} ARCH=arm64 \
            CROSS_COMPILE="$GCC64" \
            CROSS_COMPILE_ARM32="$GCC32" \
            KCFLAGS="-fcommon -Wno-error" \
            HOSTCFLAGS="-fcommon" \
            -j$(nproc)

      - name: "üì¶ Package into AnyKernel3 (FIXED)"
        run: |
          # 1. –°–∫–∞—á–∏–≤–∞–µ–º AnyKernel3
          git clone https://github.com/osm0sis/AnyKernel3.git AnyKernel3
          
          # 2. –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–±—Ä–∞–Ω–Ω–æ–µ —è–¥—Ä–æ
          cp ${{ env.kernelDir }}/${{ env.kernelName }}/${{ env.OUT_DIR }}/arch/arm64/boot/Image.gz AnyKernel3/
          
          # 3. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –ù–ê–°–¢–†–û–ô–ö–ê (–ú–∞–≥–∏—è sed)
          cd AnyKernel3
          # –ú–µ–Ω—è–µ–º –∏–º—è –¥–µ–≤–∞–π—Å–∞ –Ω–∞ jason
          sed -i 's/device.name1=.*/device.name1=jason/' anykernel.sh
          # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –∏–º–µ–Ω–∞, —á—Ç–æ–±—ã –Ω–µ –ø—É—Ç–∞—Ç—å—Å—è
          sed -i 's/device.name2=.*/device.name2=/' anykernel.sh
          sed -i 's/device.name3=.*/device.name3=/' anykernel.sh
          sed -i 's/device.name4=.*/device.name4=/' anykernel.sh
          
          # –ò–°–ü–†–ê–í–õ–Ø–ï–ú –ü–£–¢–¨ –ö –†–ê–ó–î–ï–õ–£ (–°–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ!)
          # –ó–∞–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—É—é —Å—Ç—Ä–æ–∫—É —Å OMAP –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –¥–ª—è Qualcomm
          sed -i 's|BLOCK=.*|BLOCK=/dev/block/bootdevice/by-name/boot;|' anykernel.sh
          
          # 4. –ü–∞–∫—É–µ–º –≤ ZIP
          zip -r9 ../AnyKernel-Jason-Auto.zip * -x .git README.md

      - name: "üíõ Upload Ready-to-Flash ZIP"
        uses: actions/upload-artifact@v4
        with:
          name: Flash-Me-In-TWRP
          path: AnyKernel-Jason-Auto.zip
