name: "üöÄ Build Kernels (Docker 18.04)"

env:
  CONFIGURATION: "repos.json"
  OUT_DIR: "out"

on:
  workflow_dispatch:

jobs:
  Set-repos:
    name: "üêÇ Parse repos.json"
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.generate-matrix.outputs.repos }}
    steps:
      - name: "üòÑ Checkout"
        uses: actions/checkout@v4
      - name: "üòÜ Generate Matrix"
        id: generate-matrix
        run: |
          echo "repos=$(cat ${{ env.CONFIGURATION }} | tr -d '\n')" >> $GITHUB_OUTPUT

  Build-Kernel:
    name: "üêé Build"
    needs: Set-repos
    runs-on: ubuntu-latest
    # –í–æ—Ç –∑–¥–µ—Å—å –º–∞–≥–∏—è: –∑–∞–ø—É—Å–∫–∞–µ–º –≤—Å—ë –≤–Ω—É—Ç—Ä–∏ —Å—Ç–∞—Ä–æ–π –¥–æ–±—Ä–æ–π –£–±—É–Ω—Ç—ã
    container:
      image: ubuntu:18.04
    
    strategy:
      fail-fast: false
      matrix:
        repos: ${{ fromJSON(needs.Set-repos.outputs.repos) }}
    
    env:
      kernelDir: ${{ matrix.repos.kernelSource.name }}_${{ matrix.repos.kernelSource.device }}
      kernelName: ${{ matrix.repos.kernelSource.name }}
      DEFCONFIG_NAME: ${{ matrix.repos.params.DEFCONFIG }}

    steps:
      - name: "üì¶ Install dependencies"
        run: |
          apt-get update
          apt-get install -y build-essential bc curl git zip gcc-aarch64-linux-gnu \
          gcc-arm-linux-gnueabi libssl-dev lftp zstd wget libfl-dev python2.7 \
          libarchive-tools jq
          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Python 2 –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π
          ln -sf /usr/bin/python2.7 /usr/bin/python
          ln -sf /usr/bin/python2.7 /usr/bin/python2

      - name: "üåü Clone Source"
        run: |
          mkdir -p $kernelDir
          git clone --depth=1 --branch ${{ matrix.repos.kernelSource.branch }} ${{ matrix.repos.kernelSource.repo }} $kernelDir/$kernelName

      - name: "üí´ Clone Toolchains"
        working-directory: ${{ env.kernelDir }}
        run: |
          # –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ç—É–ª—á–µ–π–Ω—ã –∏–∑ —Ç–≤–æ–µ–≥–æ repos.json
          echo '${{ toJSON(matrix.repos.toolchains) }}' | jq -c '.[]' | while read i; do
            name=$(echo $i | jq -r '.name')
            repo=$(echo $i | jq -r '.repo')
            branch=$(echo $i | jq -r '.branch')
            git clone --depth=1 --branch $branch $repo $name
          done

      - name: "üé∂ Build Kernel"
        working-directory: ${{ env.kernelDir }}/${{ env.kernelName }}
        run: |
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç–∏ –∫ —Å–∫–∞—á–∞–Ω–Ω—ã–º —Ç—É–ª—á–µ–π–Ω–∞–º
          GCC64="$(pwd)/../gcc64/bin/${{ matrix.repos.params.CROSS_COMPILE }}"
          GCC32="$(pwd)/../gcc32/bin/${{ matrix.repos.params.CROSS_COMPILE_ARM32 }}"
          
          mkdir -p ${{ env.OUT_DIR }}
          
          # 1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
          make O=${{ env.OUT_DIR }} ARCH=arm64 CROSS_COMPILE="$GCC64" ${{ env.DEFCONFIG_NAME }}
          
          # 2. –°–±–æ—Ä–∫–∞
          make O=${{ env.OUT_DIR }} ARCH=arm64 \
            CROSS_COMPILE="$GCC64" \
            CROSS_COMPILE_ARM32="$GCC32" \
            KCFLAGS="-fcommon -Wno-error" \
            HOSTCFLAGS="-fcommon" \
            -j$(nproc)

      - name: "üíõ Upload Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: Kernel-${{ matrix.repos.kernelSource.device }}-${{ github.run_id }}
          path: |
            ${{ env.kernelDir }}/${{ env.kernelName }}/${{ env.OUT_DIR }}/arch/arm64/boot/Image*
            ${{ env.kernelDir }}/${{ env.kernelName }}/${{ env.OUT_DIR }}/arch/arm64/boot/*.dtb*
